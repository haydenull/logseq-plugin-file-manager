import{j as b,r as f,V as M,a as A,R as E,b as R}from"./vendor.96376778.js";const q=function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))o(e);new MutationObserver(e=>{for(const a of e)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function t(e){const a={};return e.integrity&&(a.integrity=e.integrity),e.referrerpolicy&&(a.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?a.credentials="include":e.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(e){if(e.ep)return;e.ep=!0;const a=t(e);fetch(e.href,a)}};q();const D=async r=>{async function*s(o){if(o.kind==="file"){const e=await o.getFile();e!==null&&(e.relativePath=await r.resolve(o),yield e)}else if(o.kind==="directory")for await(const e of o.values())yield*s(e)}let t=[];for await(const o of s(r))t.push(o);return t},z=["assets","draws"],U=[/^journals/,/^pages/,/^logseq\/bak\/journals\//,/^logseq\/bak\/pages\//],L=["edn","DS_Store"],_=r=>{const s=[],t=[];return r.forEach(o=>{const e=o?.relativePath?.slice(0,-1)?.join("/")||"",a=o.name.split(".").pop()||"";z.includes(e)&&!L.includes(a)?s.push(o):U.find(i=>i.test(e))&&t.push(o)}),[s,t]},O=/!\[.*?\]\((.*)\)/g,I=/\[\[(draws\/.+\.excalidraw)]]/g,T=async(r,s)=>{const t=new Map;r.forEach(a=>{const i=a.relativePath?.join("/")||"";t.set(i,0)}),console.log("[faiz:] === stuffFilesMap",t);const o=s.map(async a=>{const i=await a.text(),w=i.matchAll(O),g=i.matchAll(I),h=[...w].map(m=>m[1]?.replaceAll(/\.\.\//g,"")),p=[...g].map(m=>m[1]);return[...h,...p]}),e=(await Promise.all(o)).filter(a=>a.length>0)?.flat();return console.log("[faiz:] === usedStuffFilesPaths",e),e.forEach(a=>{t.has(a)&&t.set(a,(t.get(a)||0)+1)}),console.log("[faiz:] === stuffFilesMap",t),r.filter(a=>t.get(a.relativePath?.join("/")||"")===0)},G=async(r,s)=>{const t=s.relativePath||[];if(t.length===0)return Promise.reject(new Error("file.relativePath is empty"));if(t.length===1)return r.removeEntry(t[0]);let o=r;for(let e=0;e<t.length-1;e++)o=await o.getDirectoryHandle(t[e]);return o.removeEntry(t[t.length-1])};function F(r){const s=document.createElement("textarea");s.value=r,document.body.appendChild(s),s.select(),document.execCommand("copy"),document.body.removeChild(s)}const P=async(r,s="logseq")=>{if(s==="browser")return URL.createObjectURL(r);const t=await logseq.App.getCurrentGraph();return t?`file:///${t.path}/${r.relativePath?.join("/")}`:Promise.reject(new Error("graph is null"))},l=b.exports.jsx,u=b.exports.jsxs,H=({env:r})=>{const[s,t]=f.exports.useState([]),[o,e]=f.exports.useState("unauthorized"),[a,i]=f.exports.useState(),[w,g]=f.exports.useState("light"),h=f.exports.useRef(),p=o==="loaded"&&s.length>0;console.log("[faiz:] === unusedStuffFiles",s);const m=async()=>{if(h.current){for(let n=0;n<s.length;n++)if(s[n].checked){const d=s[n].file;await G(h.current,d),t(c=>c.filter(y=>y.file.name!==d.name))}}},S=async()=>{e("loading");let n;try{if(n=await window.showDirectoryPicker(),n.kind!=="directory")return e("unauthorized"),logseq.App.showMsg("Please select a directory","error")}catch{return e("unauthorized"),logseq.App.showMsg("Failed to get authorization","error")}h.current=n;const d=await D(n),[c,y]=_(d),x=await T(c,y);console.log("[faiz:] === _unusedStuffFiles",x),t(x.map(v=>({file:v,checked:!0}))),e("loaded")},k=n=>{const{value:d}=n.target;t(s.map(c=>d===c.file.name?{...c,checked:!c.checked}:c))},N=async n=>{const d=await P(n,r);i(d)},C=async n=>{if(r==="browser"){F(n.relativePath?.join("/")||"path not found");return}const d=await P(n);F(d.replace("file:///","")),logseq.App.showMsg("Copied to clipboard success","success")},j=()=>{logseq.App.openExternalLink("https://haydenull.github.io/logseq-plugin-file-manager/")};return f.exports.useEffect(()=>{logseq.App.getStateFromStore("ui/theme").then(n=>{g(n)}),logseq.App.onThemeModeChanged(n=>{g(n.mode)})},[]),u("main",{className:"w-screen h-screen flex items-center justify-center",children:[l("div",{className:"w-screen h-screen fixed top-0 left-0 bg-black bg-opacity-30",onClick:()=>logseq.hideMainUI()}),u("article",{className:"w-5/6 h-5/6 z-0 rounded shadow flex","data-theme":w,children:[u("div",{className:"flex flex-col w-2/3",children:[l("h3",{className:"mb-0",children:"File Manager"}),r==="logseq"&&u("span",{className:"text-sm text-gray-400",children:["Plugins cannot delete files, if needed please go to the ",l("a",{onClick:j,children:"web version"}),"."]}),u("section",{className:"mb-4 mt-6",children:[l("span",{role:"button",className:"px-2 py-2 text-xs",onClick:S,children:"Search Unused Stuff"}),r==="browser"&&p&&l("span",{role:"button",className:"py-2 px-2 ml-2 text-xs bg-rose-500 border-rose-500 hover:bg-rose-600",onClick:m,children:"Delete"})]}),p&&l("div",{className:"mb-1 text-base",children:"Unused Stuff Files:"}),u("div",{className:"flex flex-1 overflow-auto",children:[o==="unauthorized"&&l("div",{className:"mt-28",children:"Please authorize the plugin to access your files."}),o==="loading"&&l("div",{className:"mt-28","aria-busy":"true",children:"Searching..."}),o==="loaded"&&s.length===0&&l("div",{className:"mt-28",children:"No unused stuff files found."}),p&&l("div",{children:s.map((n,d)=>u("div",{className:"flex items-center",children:[u("label",{className:"text-sm",children:[l("input",{className:"w-4 h-4",type:"checkbox",checked:n.checked,value:n.file.name,onChange:c=>k(c)}),n.file.name]}),l("a",{className:"ml-1 cursor-pointer",onClick:c=>N(n.file),"data-tooltip":"Preview",children:l(M,{})}),l("a",{className:"ml-1 cursor-pointer",onClick:c=>C(n.file),"data-tooltip":"Copy file path",children:l(A,{})})]},n.file.name))})]})]}),l("iframe",{className:"flex-1 ml-5 shadow-lg",src:a})]})]})};V("browser");function V(r){E.render(l(R.StrictMode,{children:l(H,{env:r})}),document.getElementById("root"))}
